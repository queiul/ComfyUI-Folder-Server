<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Metadata API Extension Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            margin-top: 1.5em;
        }
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: 5px;
        }
        code {
            font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
            background-color: #f5f7f9;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 0.9em;
        }
        pre {
            background-color: #f5f7f9;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        pre code {
            background-color: transparent;
            padding: 0;
        }
        .endpoint {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            padding: 15px;
            border-radius: 3px;
        }
        .method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            color: white;
            margin-right: 10px;
            font-weight: bold;
        }
        .post {
            background-color: #27ae60;
        }
        .get {
            background-color: #3498db;
        }
        .function {
            margin: 30px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #ffffff;
        }
        .function-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .function-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .function-type {
            color: #7f8c8d;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f5f7f9;
        }
        .parameter-name {
            font-weight: bold;
        }
        .note {
            background-color: #fef9e7;
            border-left: 4px solid #f1c40f;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 3px;
        }
        .warning {
            background-color: #fdedec;
            border-left: 4px solid #e74c3c;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 3px;
        }
        .tab-container {
            margin: 20px 0;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f5f7f9;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab-button.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Enhanced Metadata API Extension Documentation</h1>
    
    <p>The Enhanced Metadata API Extension for ComfyUI provides functionality to add custom metadata to various file types generated by ComfyUI workflows. This extension hooks into the ComfyUI prompt execution system to automatically attach user-defined metadata to output files.</p>
    
    <h2>Overview</h2>
    <p>This extension adds the ability to:</p>
    <ul>
        <li>Include custom metadata with your ComfyUI prompt requests</li>
        <li>Automatically attach that metadata to generated output files</li>
        <li>Support for multiple file formats including images, videos, and 3D models</li>
        <li>Fallback methods when preferred metadata embedding options aren't available</li>
    </ul>

    <h2>Installation</h2>
    <p>1. Copy this extension file to your ComfyUI custom_nodes folder</p>
    <p>2. Restart ComfyUI server</p>
    <p>3. Optional: Install ffmpeg if you want embedded metadata in video files</p>

    <h2>API Endpoints</h2>
    
    <div class="endpoint">
        <h3><span class="method post">POST</span> /folder_server/prompt</h3>
        <p>Submit a ComfyUI workflow with custom metadata. The metadata will be stored temporarily and applied to any output files generated by the workflow.</p>
        
        <h4>Request Body</h4>
        <pre><code>{
  "prompt": { /* Standard ComfyUI workflow JSON */ },
  "custom_metadata": { /* Your custom metadata object */ }
}</code></pre>
        
        <h4>Response</h4>
        <pre><code>{
  "prompt_id": "unique-prompt-id",
  "number": 42,
  "node_errors": {},
  "custom_metadata_status": "stored"
}</code></pre>
        
        <div class="note">
            <strong>Note:</strong> This endpoint extends the standard ComfyUI prompt endpoint by adding metadata handling. All other functionality remains identical to the standard endpoint.
        </div>
    </div>

    <h2>Core Functions</h2>

    <div class="function">
        <div class="function-header">
            <span class="function-name">inject_metadata_to_image(file_path, metadata)</span>
            <span class="function-type">Function</span>
        </div>
        <p>Adds custom metadata to an image file. Supports multiple image formats based on extension.</p>
        
        <h4>Parameters</h4>
        <table>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
            <tr>
                <td class="parameter-name">file_path</td>
                <td>string</td>
                <td>Path to the image file</td>
            </tr>
            <tr>
                <td class="parameter-name">metadata</td>
                <td>object</td>
                <td>Dictionary containing metadata to add</td>
            </tr>
        </table>
        
        <h4>Supported Formats</h4>
        <ul>
            <li><strong>PNG</strong>: Embeds metadata directly using PngInfo (when available)</li>
            <li><strong>JPEG, TIFF, WebP, BMP</strong>: Creates companion metadata file and attempts to add EXIF reference</li>
        </ul>
        
        <h4>Return Value</h4>
        <p>Boolean - True if metadata was successfully added, False otherwise</p>
    </div>

    <div class="function">
        <div class="function-header">
            <span class="function-name">inject_metadata_to_video(video_path, metadata)</span>
            <span class="function-type">Function</span>
        </div>
        <p>Adds custom metadata to a video file using ffmpeg (if available).</p>
        
        <h4>Parameters</h4>
        <table>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
            <tr>
                <td class="parameter-name">video_path</td>
                <td>string</td>
                <td>Path to the video file</td>
            </tr>
            <tr>
                <td class="parameter-name">metadata</td>
                <td>object</td>
                <td>Dictionary containing metadata to add</td>
            </tr>
        </table>
        
        <h4>Supported Formats</h4>
        <ul>
            <li><strong>MP4, MOV, AVI, WebM, MKV</strong>: Embeds metadata using ffmpeg or creates companion file as fallback</li>
        </ul>
        
        <div class="note">
            <strong>Note:</strong> Requires ffmpeg to be installed for direct embedding. Falls back to companion file if ffmpeg is not available.
        </div>
        
        <h4>Return Value</h4>
        <p>Boolean - True if metadata was successfully added, False otherwise</p>
    </div>

    <div class="function">
        <div class="function-header">
            <span class="function-name">inject_metadata_to_3d_model(model_path, metadata)</span>
            <span class="function-type">Function</span>
        </div>
        <p>Adds custom metadata to a 3D model file. For GLTF, attempts to embed metadata directly.</p>
        
        <h4>Parameters</h4>
        <table>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
            <tr>
                <td class="parameter-name">model_path</td>
                <td>string</td>
                <td>Path to the 3D model file</td>
            </tr>
            <tr>
                <td class="parameter-name">metadata</td>
                <td>object</td>
                <td>Dictionary containing metadata to add</td>
            </tr>
        </table>
        
        <h4>Supported Formats</h4>
        <ul>
            <li><strong>GLTF</strong>: Embeds metadata directly in the "extras" field of the asset</li>
            <li><strong>OBJ, STL, FBX, GLB</strong>: Creates companion metadata file</li>
        </ul>
        
        <h4>Return Value</h4>
        <p>Boolean - True if metadata was successfully added, False otherwise</p>
    </div>

    <h2>Usage Examples</h2>

    <div class="tab-container">
        <div class="tab-buttons">
            <div class="tab-button active" onclick="openTab(event, 'pythonExample')">Python</div>
            <div class="tab-button" onclick="openTab(event, 'javascriptExample')">JavaScript</div>
            <div class="tab-button" onclick="openTab(event, 'curlExample')">cURL</div>
        </div>
        
        <div id="pythonExample" class="tab-content active">
            <pre><code>import requests
import json

# Your ComfyUI workflow JSON
workflow_json = {
    # Your standard workflow goes here
}

# Custom metadata to add to all output files
custom_metadata = {
    "creator": "John Doe",
    "project": "My Amazing Project",
    "version": "1.0",
    "tags": ["landscape", "starry-night", "ai-generated"],
    "prompt": "A beautiful landscape with a starry night",
    "parameters": {
        "seed": 12345,
        "steps": 20,
        "cfg": 7.0
    }
}

# Combine into a single request
payload = {
    "prompt": workflow_json,
    "custom_metadata": custom_metadata
}

# Send to the custom endpoint
response = requests.post(
    "http://localhost:8188/folder_server/prompt",
    json=payload
)

# Check the result
if response.status_code == 200:
    result = response.json()
    print(f"Prompt ID: {result['prompt_id']}")
    print(f"Metadata status: {result.get('custom_metadata_status')}")
else:
    print(f"Error: {response.status_code}")
    print(response.text)</code></pre>
        </div>
        
        <div id="javascriptExample" class="tab-content">
            <pre><code>// Your ComfyUI workflow JSON
const workflowJson = {
    // Your standard workflow goes here
};

// Custom metadata to add to all output files
const customMetadata = {
    "creator": "John Doe",
    "project": "My Amazing Project",
    "version": "1.0",
    "tags": ["landscape", "starry-night", "ai-generated"],
    "prompt": "A beautiful landscape with a starry night",
    "parameters": {
        "seed": 12345,
        "steps": 20,
        "cfg": 7.0
    }
};

// Combine into a single request
const payload = {
    prompt: workflowJson,
    custom_metadata: customMetadata
};

// Send to the custom endpoint
fetch('http://localhost:8188/folder_server/prompt', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
})
.then(response => response.json())
.then(data => {
    console.log(`Prompt ID: ${data.prompt_id}`);
    console.log(`Metadata status: ${data.custom_metadata_status}`);
})
.catch(error => {
    console.error('Error:', error);
});</code></pre>
        </div>
        
        <div id="curlExample" class="tab-content">
            <pre><code>curl -X POST http://localhost:8188/folder_server/prompt \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": {
      // Your standard ComfyUI workflow goes here
    },
    "custom_metadata": {
      "creator": "John Doe",
      "project": "My Amazing Project",
      "version": "1.0",
      "tags": ["landscape", "starry-night", "ai-generated"],
      "prompt": "A beautiful landscape with a starry night",
      "parameters": {
        "seed": 12345,
        "steps": 20,
        "cfg": 7.0
      }
    }
  }'</code></pre>
        </div>
    </div>

    <h2>Limitations</h2>
    <ul>
        <li>Direct metadata embedding requires specific libraries or external tools (e.g., PIL with PngInfo, ffmpeg)</li>
        <li>For formats without direct embedding support, a companion JSON file is created</li>
        <li>Video metadata embedding requires ffmpeg to be installed</li>
        <li>Metadata stored in memory until output files are generated; if ComfyUI crashes or restarts, pending metadata is lost</li>
    </ul>

    <script>
        function openTab(evt, tabName) {
            var i, tabContent, tabButtons;
            
            // Hide all tab content
            tabContent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabContent.length; i++) {
                tabContent[i].className = tabContent[i].className.replace(" active", "");
            }
            
            // Remove "active" class from all tab buttons
            tabButtons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabButtons.length; i++) {
                tabButtons[i].className = tabButtons[i].className.replace(" active", "");
            }
            
            // Show the current tab and add "active" class to the button
            document.getElementById(tabName).className += " active";
            evt.currentTarget.className += " active";
        }
    </script>
</body>
</html>